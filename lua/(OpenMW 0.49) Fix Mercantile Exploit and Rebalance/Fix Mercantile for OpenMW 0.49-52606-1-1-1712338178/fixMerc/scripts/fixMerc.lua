-- Save to my_lua_mod/scripts/example/player.lua

-- remember that prices depend on your stamina
-- the mod makes sure that the vendor's rating is always at least 25 points above the player's, but since mercantile's contribution to this rating is capped at 100 points, you'd be able to exploit the system at 76 mercantile + 50 personality + 100 luck
local ONLY_FIX_EXPLOIT = false --set to true to not adjust the mercantile price curve and only prevent exploits by keeping vendor mercantile 25 points above your rating, in this case you can safely disable the easyBribe .omwaddon
local ATTRIBUTE_TARGET = 75
local SKILL_TARGET = 75
local TARGET_MULT = 0.52 -- TARGET_MULT=1 means that the npc will always have the maximum level. TARGET_MULT=0 means that the npc will always have *your* level (plus 25 points to make it non-exploitable)
local TOUCH_NON_VENDOR_NPCS = true -- since merchants now have such high mercantile, its harder to bribe them. the included esp increases bribe modifiers to 1.5x, but that would make other npcs too easily bribable. set to true to make sure that other npcs you talk to have at least 40 mercantile skill and 50 luck + personality


local types = require('openmw.types')
local self = require('openmw.self')

local ALL_vendors = {
	["dagoth aladus"] = true,
	["dagoth baler"] = true,
	["dagoth daynil"] = true,
	["dagoth delnus"] = true,
	["dagoth drals"] = true,
	["Dagoth Draven"] = true,
	["dagoth elam"] = true,
	["dagoth fals"] = true,
	["dagoth fervas"] = true,
	["dagoth fovon"] = true,
	["dagoth galmis"] = true,
	["dagoth girer"] = true,
	["dagoth ienas"] = true,
	["dagoth mendras"] = true,
	["dagoth mulis"] = true,
	["dagoth muthes"] = true,
	["dagoth nilor"] = true,
	["dagoth ralas"] = true,
	["dagoth soler"] = true,
	["dagoth velos"] = true,
	["mudcrab_unique"] = true,
	["scamp_creeper"] = true,
	["wraith_sul_senipul"] = true,
	["ababael timsar-dadisun"] = true,
	["abelle chriditte"] = true,
	["addut-lamanu"] = true,
	["Agning"] = true,
	["agrippina herennia"] = true,
	["agronian guy"] = true,
	["ajira"] = true,
	["alarvyne indalas"] = true,
	["Alcedonia Amnis"] = true,
	["alds baro"] = true,
	["alenus vendu"] = true,
	["allding"] = true,
	["alusaron"] = true,
	["alveno andules"] = true,
	["amarie charien"] = true,
	["anarenen"] = true,
	["anas ulven"] = true,
	["ancola"] = true,
	["andil"] = true,
	["andilu drothan"] = true,
	["anis seloth"] = true,
	["anruin"] = true,
	["arangaer"] = true,
	["arantamo"] = true,
	["areas"] = true,
	["arenara"] = true,
	["arnand liric"] = true,
	["arrille"] = true,
	["aryne telnim"] = true,
	["ashuma-nud matluberib"] = true,
	["ashumanu eraishah"] = true,
	["ashur-dan"] = true,
	["ather belden"] = true,
	["audenian valius"] = true,
	["aunius autrus"] = true,
	["aurane frernis"] = true,
	["avon oran"] = true,
	["bacola closcius"] = true,
	["baissa"] = true,
	["balen andrano"] = true,
	["banor seran"] = true,
	["baren alen"] = true,
	["barusi venim"] = true,
	["belos falos"] = true,
	["Belwen"] = true,
	["benunius agrudilius"] = true,
	["bereditte jastal"] = true,
	["bereditte jastal_out"] = true,
	["berela andrano"] = true,
	["bervaso thenim"] = true,
	["bervyn lleryn"] = true,
	["berwen"] = true,
	["bevene releth"] = true,
	["big helende"] = true,
	["bildren areleth"] = true,
	["bivale teneran"] = true,
	["boderi farano"] = true,
	["bolnor andrani"] = true,
	["bols indalen"] = true,
	["both gro-durug"] = true,
	["brarayni sarys"] = true,
	["brathus dals"] = true,
	["bronrod_the_roarer"] = true,
	["brynjolfr"] = true,
	["burcanius varo"] = true,
	["Catia Sosia"] = true,
	["chaplain ogrul"] = true,
	["chargen boat guard 1"] = true,
	["chargen boat guard 2"] = true,
	["chirranirr"] = true,
	["cienne sintieve"] = true,
	["clagius clanler"] = true,
	["cocistian quaspus"] = true,
	["codus callonus"] = true,
	["corrudus secunia"] = true,
	["craeita jullalian"] = true,
	["Crito Olcinius"] = true,
	["crulius pontanian"] = true,
	["dabienne mornardl"] = true,
	["Dalam Gavyn"] = true,
	["dalos golathyn"] = true,
	["dandera selaro"] = true,
	["danoso andrano"] = true,
	["danso indules"] = true,
	["Daron"] = true,
	["daynali dren"] = true,
	["daynes redothril"] = true,
	["dead elite ord"] = true,
	["dead ordinator"] = true,
	["dead ordinator_key"] = true,
	["dileno lloran"] = true,
	["Dirver Relas"] = true,
	["dolyn rols"] = true,
	["dorisa darvel"] = true,
	["dralasa nithryon"] = true,
	["dralval andrano"] = true,
	["Drarayne Girith"] = true,
	["drelasa ramothran"] = true,
	["dronos llervu"] = true,
	["dulian"] = true,
	["dulnea ralaal"] = true,
	["dunel saryon"] = true,
	["dunsalipal dun-ahhe"] = true,
	["Edre Retene"] = true,
	["Elbert Nermarc"] = true,
	["eldrilu dalen"] = true,
	["elegal"] = true,
	["elegnan"] = true,
	["elo arethan"] = true,
	["elynu saren"] = true,
	["ergnir"] = true,
	["eris telas"] = true,
	["erla"] = true,
	["ernand thierry"] = true,
	["ery"] = true,
	["fadase selvayn"] = true,
	["falanaamo"] = true,
	["falvel arenim"] = true,
	["Fanildil"] = true,
	["fara"] = true,
	["faras thirano"] = true,
	["felara andrethi"] = true,
	["felayn andral"] = true,
	["fenas madach"] = true,
	["ferele athram"] = true,
	["folms mirel"] = true,
	["folvys andalor"] = true,
	["fomesa tharys"] = true,
	["Fonari Indaren"] = true,
	["fonas retheran"] = true,
	["foves arenim"] = true,
	["Frik"] = true,
	["fryfnhild"] = true,
	["gadayn andarys"] = true,
	["gadela andus"] = true,
	["galar rothan"] = true,
	["galbedir"] = true,
	["galen berer"] = true,
	["galero andaram"] = true,
	["galore salvi"] = true,
	["Galsa Andrano"] = true,
	["galtis guvron"] = true,
	["galuro belan"] = true,
	["ganalyn saram"] = true,
	["garas seloth"] = true,
	["garothmuk gro-muzgub"] = true,
	["germia"] = true,
	["gilan daynes"] = true,
	["gils drelas"] = true,
	["gilyan sedas"] = true,
	["gilyne omoren"] = true,
	["gindas ildram"] = true,
	["gladroon"] = true,
	["goldyn belaram"] = true,
	["gomeso sarano"] = true,
	["gorven menas"] = true,
	["Guldrise Dralor"] = true,
	["guls llervu"] = true,
	["habasi"] = true,
	["hakar the candle"] = true,
	["hannabi zabynatus"] = true,
	["hecerinde"] = true,
	["heifnir"] = true,
	["helviane desele"] = true,
	["hession"] = true,
	["hetman abelmawia"] = true,
	["hickim"] = true,
	["hinald"] = true,
	["hjotra the peacock"] = true,
	["hlendrisa seleth"] = true,
	["hlodala savel"] = true,
	["hodlismod"] = true,
	["hreirek the lean"] = true,
	["hrundi"] = true,
	["huleeya"] = true,
	["ibarnadad assirnarari"] = true,
	["idonea munia"] = true,
	["ilen faveran"] = true,
	["irgola"] = true,
	["irna maryon"] = true,
	["Iulus Truptor"] = true,
	["j'rasha"] = true,
	["janand maulinie"] = true,
	["jeanne"] = true,
	["jobasha"] = true,
	["jolda"] = true,
	["Kaye"] = true,
	["kjeld"] = true,
	["kurapli"] = true,
	["ladia flarugrius"] = true,
	["Lalatia Varian"] = true,
	["lanabi"] = true,
	["Landorume"] = true,
	["Lassour Zenammu"] = true,
	["Laurina Maria"] = true,
	["Letreius Muco"] = true,
	["lirielle stoine"] = true,
	["llandris thirandus"] = true,
	["llarara omayn"] = true,
	["llathyno hlaalu"] = true,
	["Llemisa Marys"] = true,
	["llether vari"] = true,
	["llevas fels"] = true,
	["lliros tures"] = true,
	["lliryn fendyn"] = true,
	["llorayna sethan"] = true,
	["lloros sarano"] = true,
	["lorbumol gro-aglakh"] = true,
	["lord cluttermonkey"] = true,
	["lucretinaus olcinius"] = true,
	["madrale thirith"] = true,
	["malpenix blonia"] = true,
	["mamaea"] = true,
	["manara othan"] = true,
	["mandur omalen"] = true,
	["manicky"] = true,
	["manirai"] = true,
	["manse andus"] = true,
	["marasa aren"] = true,
	["maren uvaren"] = true,
	["massarapal"] = true,
	["mebestian ence"] = true,
	["meder nulen"] = true,
	["mehra drora"] = true,
	["mehra helas"] = true,
	["meldor"] = true,
	["melie frenck"] = true,
	["methal seran"] = true,
	["mevel fererus"] = true,
	["mevure hlen"] = true,
	["milar maryon"] = true,
	["milie hastien"] = true,
	["minasi bavani"] = true,
	["miraso seran"] = true,
	["mirisa"] = true,
	["miun_gei"] = true,
	["mivanu retheran"] = true,
	["moroni uvelas"] = true,
	["mororurg"] = true,
	["mug gro-dulob"] = true,
	["muriel sette"] = true,
	["nalcarya of white haven"] = true,
	["nalis gals"] = true,
	["nalvilie saren"] = true,
	["naspis apinia"] = true,
	["Nebia Amphia"] = true,
	["Nerile Andaren"] = true,
	["nibani maesa"] = true,
	["nileno dorvayn"] = true,
	["nilvyn drothan"] = true,
	["niras farys"] = true,
	["nivos drivam"] = true,
	["onlyhestandsthere"] = true,
	["orero omothan"] = true,
	["orns omaren"] = true,
	["peragon"] = true,
	["peregrina cnisia"] = true,
	["Perien Aurelie"] = true,
	["phane rielle"] = true,
	["pierlette rostorard"] = true,
	["ra'tesh"] = true,
	["ra'virr"] = true,
	["radras"] = true,
	["ralds oril"] = true,
	["ralen tilvur"] = true,
	["ranosa gilvayn"] = true,
	["raril giral"] = true,
	["rarvela teran"] = true,
	["rathal barus"] = true,
	["raviso andalas"] = true,
	["ravoso aryon"] = true,
	["relms gilvilo"] = true,
	["rilvase avani"] = true,
	["rirnas athren"] = true,
	["rissinia"] = true,
	["rogdul gro-bularz"] = true,
	["rolasa oren"] = true,
	["Roner Arano"] = true,
	["Sabrina Vitellia"] = true,
	["saetring"] = true,
	["salen ravel"] = true,
	["Sanaso Sarothran"] = true,
	["saras orelu"] = true,
	["Sathyn Andrano"] = true,
	["Sauleius Cullian"] = true,
	["savard"] = true,
	["scelian plebo"] = true,
	["sedam omalen"] = true,
	["sedris omalen"] = true,
	["segunivus mantedius"] = true,
	["selkirnemus"] = true,
	["selvura andrano"] = true,
	["sernsi drelas"] = true,
	["sevyni saryon"] = true,
	["shadbak gra-burbug"] = true,
	["sharn gra-muzgob"] = true,
	["shenk"] = true,
	["shulki ashunbabi"] = true,
	["simine fralinie"] = true,
	["sinnammu mirpal"] = true,
	["Sirollus Saccus"] = true,
	["skinkintreesshade"] = true,
	["snedbrir the smith"] = true,
	["sodrara andalas"] = true,
	["somutis vunnis"] = true,
	["sonummu zabamat"] = true,
	["sorosi radobar"] = true,
	["sottilde"] = true,
	["sovali uvayn"] = true,
	["sovor trandel"] = true,
	["Sunel Hlas"] = true,
	["syloria siruliulus"] = true,
	["Synnolian Tunifus"] = true,
	["tanar llervi"] = true,
	["tarvyn faren"] = true,
	["telis salvani"] = true,
	["telvon llethan"] = true,
	["Ten-Tongues_Weerhat"] = true,
	["tendris vedran"] = true,
	["teril savani"] = true,
	["tervur braven"] = true,
	["thaeril"] = true,
	["thanelen velas"] = true,
	["thervul serethi"] = true,
	["thongar"] = true,
	["thorek"] = true,
	["tiras sadus"] = true,
	["tivam sadri"] = true,
	["todd"] = true,
	["tongue_toad"] = true,
	["traldrisa tervayn"] = true,
	["Trasteve"] = true,
	["trivura arenim"] = true,
	["tunila omavel"] = true,
	["tusamircil"] = true,
	["tussi"] = true,
	["tuveso beleth"] = true,
	["tyermaillin"] = true,
	["ulfrun"] = true,
	["ulmiso maloren"] = true,
	["ulumpha gra-sharob"] = true,
	["Ungeleb"] = true,
	["ureso drath"] = true,
	["urfing"] = true,
	["urjorad"] = true,
	["used clutter salesman"] = true,
	["uulernil"] = true,
	["uvele berendas"] = true,
	["vasesius viciulus"] = true,
	["vaval selas"] = true,
	["vedran balen"] = true,
	["verara rendo"] = true,
	["verick gemain"] = true,
	["wayn"] = true,
	["yambagorn gor-shulor"] = true,
	["ygfa"] = true,
	["zanmulk sammalamus"] = true,
	["zebba benamamat"] = true,
	["zeno faustus"] = true
	}
	

local function onActivated(actor)
	
	actor:sendEvent("FixMerc_NPCActivated",self)
	
	if not ALL_vendors[self.object.recordId] then
		if TOUCH_NON_VENDOR_NPCS and not ONLY_FIX_EXPLOIT then
			-- included esp sets the bribing modifiers to 1.5x, so we have to make sure that bribing isn't too easy with non-merchant npcs
			local mercantile = types.NPC.stats.skills.mercantile
			local luck = types.NPC.stats.attributes.luck
			local personality = types.NPC.stats.attributes.personality
			if personality(self).base < 55 then
				personality(self).base = 55
			end
			if luck(self).base <50 then
				luck(self).base = 50
			end
			if mercantile(self).base <40 then
				mercantile(self).base = 40
			end
		end
		return
	end
	
	----[[
	local mercantile = types.NPC.stats.skills.mercantile
	local luck = types.NPC.stats.attributes.luck
	local personality = types.NPC.stats.attributes.personality
	local playerRating = mercantile(actor).modified + 0.2*personality(actor).modified + 0.1*luck(actor).modified
	local targetRating = math.min(ATTRIBUTE_TARGET,50)*0.2 + math.min(ATTRIBUTE_TARGET,100)*0.1 + SKILL_TARGET +26
	local merchantBase = 0.2*personality(self).modified + 0.1*luck(self).modified + mercantile(self).modified
	local calculatedRating = math.max(playerRating+26,(playerRating*(1-TARGET_MULT) + targetRating*TARGET_MULT)) -- always needs to be ~25 above player rating
	if ONLY_FIX_EXPLOIT then
		calculatedRating = math.max(playerRating+26, merchantBase)
	end
	if calculatedRating > 109 then --only up to 100 mercantile contribute to the BASE offer, but i assume barely any npc has less than 30 in his attributes so we get another 9 points headroom before we have to mess with their attributes
		if personality(self).modified < 50 then
			personality(self).base = math.max(math.min(personality(self).base,70),30,personality(self).base+50-personality(self).modified)
		end
		if luck(self).modified <100 then
			luck(self).base = math.max(30,luck(self).base+100-luck(self).modified)
		end
	end
	merchantBase = 0.2*personality(self).modified + 0.1*luck(self).modified + mercantile(self).modified
	
	mercantile(self).base = math.max(0,math.floor(mercantile(self).base+calculatedRating-merchantBase))
	
	-- ]]--
end

-- int MechanicsManager::getBarterOffer
-- bool Trading::haggle

return { engineHandlers = { onActivated = onActivated } }